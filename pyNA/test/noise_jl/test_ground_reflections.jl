using BenchmarkTools
using Test
using CSV
using DataFrames

include("../../src/noise_src_jl/ground_reflections.jl")

struct Settings_ground_effects
	N_f
	N_b
	sigma
	a_coh
end
settings = Settings_ground_effects(24, 5, 291.0 * 515.379, 0.01)

struct Data_ground_effects
	f_sb
	Faddeeva_itau_re 
	Faddeeva_itau_im
	Faddeeva_real
	Faddeeva_imag
end

l_i = 16
f = 10 .^ (0.1 * range(1+l_i, 40, length=24))
f_sb = zeros(settings.N_b * settings.N_f)
m = (settings.N_b - 1) / 2.
w = 2. ^ (1 / (3. * settings.N_b))
for k in 0:1:settings.N_f-1
    for h in 0:1:settings.N_b-1
        f_sb[k * settings.N_b + h+1] = w ^ (h - m) * f[k+1]
    end
end

data_fadd_real = DataFrame(CSV.File("../../data/propagation/Faddeeva_real_small.csv"))
data_fadd_imag = DataFrame(CSV.File("../../data/propagation/Faddeeva_imag_small.csv"))

Faddeeva_itau_re = Array(data_fadd_real)[1, 2:end]
Faddeeva_itau_im = Array(data_fadd_imag)[2:end, 1]
Faddeeva_real = Array(data_fadd_real)[2:end, 2:end]
Faddeeva_imag = Array(data_fadd_imag)[2:end, 2:end]
data = Data_ground_effects(f_sb, Faddeeva_itau_re,Faddeeva_itau_im,Faddeeva_real,Faddeeva_imag)

@testset "ground reflection module" begin
    
	## Test 1: example from the nasa stca
	# Inputs
	x_obs = [6499.860000000001, 0.0, 1.2192]
	r = [895.7785893881709]
	beta = [49.93907595256916]
	c_bar = [349.9860553285613]
	rho_0 = [1.11302898]

	sol = ground_reflections(settings, data, x_obs, r, beta, c_bar, rho_0)

	G = reshape([1.8949118591305927, 1.7504526441838117, 1.6006926712467213, 1.4464604022564869, 1.2888445559278665, 1.131971085148046, 0.9720775060777731, 0.8139779650670209, 0.6601810438355007, 0.513636602548482, 0.37996844573431776, 0.25833648556303546, 0.1554749794068866, 0.07608190298083373, 0.025155513363887883, 0.007836790249233783, 0.028562070808970663, 0.09272883215031102, 0.20445379299689392, 0.36672941209138554, 0.576791365587195, 0.8410549269387222, 1.1525043438411522, 1.5037587104343753, 1.8832682722368577, 2.2682021344090146, 2.651456209294173, 3.001275668119961, 3.289215160012983, 3.4853407828729472, 3.560915336896338, 3.4954178483123277, 3.272700832232209, 2.8940275303090233, 2.3805458927010186, 1.7874769362663545, 1.1613039675376657, 0.599342757823339, 0.19865971672692773, 0.04874994533109067, 0.20338095592976368, 0.6728100140558937, 1.388208143135052, 2.2006644804458735, 2.899785629352489, 3.2602402943767013, 3.1356905153603667, 2.498870372293019, 1.5315424432313551, 0.5975539893856061, 0.12542282780309533, 0.37895342118789777, 1.3072045462437023, 2.425704706316739, 3.0274681843322213, 2.649063958541207, 1.4667362171124156, 0.37472929267669586, 0.3517834283841572, 1.495549876726954, 2.661753955115795, 2.543070934348984, 1.1650761933666676, 0.28317177683089456, 1.177777087865488, 2.502889475533177, 2.0782773717225664, 0.5767268492536216, 0.8467695889957203, 2.3121845781211063, 1.7540247362838812, 0.4801276828773672, 1.6160576268006948, 2.0355411881123633, 0.6174773454849913, 1.541546817895462, 1.7492856893722786, 0.689768676304552, 1.904305084938692, 0.9444513846778653, 1.4503798597114894, 1.275694180807776, 1.2517328715681144, 1.2859098682878458, 1.3130202742101886, 1.1254540989392925, 1.4515264256047449, 1.0101261112991229, 1.3381942577196706, 1.2672862564594334, 1.0827302720190055, 1.210216550725496, 1.2556616882380254, 1.1895527427054284, 1.14701391852183, 1.1428781317186962, 1.146892268093154, 1.1458303278724231, 1.1421224310972244, 1.1385141204562108, 1.133640690334233, 1.1228934202006908, 1.1075934147790174, 1.1035115100513975, 1.1057455658070159, 1.094028925510474, 1.0912566495685097, 1.0850129682695613, 1.0814374200776145, 1.0759509691664404, 1.071935264846886, 1.0678924954947813, 1.0639515660024212, 1.0602288800895854, 1.0567169008497703, 1.053453324556303, 1.0503092125313376, 1.0473417887476746, 1.044548625713981, 1.0419192200323382], (1, settings.N_f*settings.N_b))

	@test(isapprox(sol, G, rtol=1e-6))

end
